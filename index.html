<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>提莫快跑 - 轮回 (Heirloom Edition)</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Damage Overlay -->
    <div id="damage-overlay"></div>

    <!-- Portrait-first: no forced landscape overlay -->

    <!-- Splash / Loading Screen -->
    <div id="splash-screen">
        <div class="splash-inner">
            <div class="splash-title">提莫快跑</div>
            <div class="splash-subtitle">轮回 · 传承</div>
            <div class="splash-tip">点击进入</div>
        </div>
    </div>

    <!-- Main Menu -->
    <div id="main-menu" class="hidden">
        <div class="hub-wrap stage-focus">
            <!-- Portrait Lobby Layout:
                 Top row: avatar (left) + resources (right)
                 Main: stage card (primary CTA)
                 Bottom: dock icons -->
            <div class="hub-portrait" aria-label="大厅">
                <div class="hub-row hub-row-top" aria-label="顶部栏">
                    <button id="hub-profile-btn" class="hub-avatar-btn compact" title="个人信息">
                        <div class="hub-avatar-ring">
                            <div class="hub-avatar">👤</div>
                        </div>
                        <div class="hub-avatar-name">玩家</div>
                    </button>
                    <div class="hub-top-stats" aria-label="资源栏">
                        <div class="hub-pill" title="技能碎片（用于局外技能升级）">
                            <span class="hub-pill-icon">💠</span>
                            <span class="hub-pill-value" id="meta-skill-shards">0</span>
                        </div>
                        <div class="hub-pill" title="金币">
                            <span class="hub-pill-icon">🪙</span>
                            <span class="hub-pill-value" id="meta-gold">0</span>
                        </div>
                        <div class="hub-pill" title="宝石">
                            <span class="hub-pill-icon">💎</span>
                            <span class="hub-pill-value" id="meta-gems">0</span>
                        </div>
                    </div>
                </div>

                <div class="hub-row hub-row-stage" aria-label="进入关卡">
                    <div class="hub-stage-card">
                        <div class="hub-stage-header">
                            <div class="hub-stage-kicker">主线 · 进入关卡</div>
                            <div class="hub-stage-badges" aria-label="当前关卡信息">
                                <span class="hub-chip">第 <span id="hub-selected-stage">1</span> 关</span>
                                <span class="hub-chip ghost" id="hub-selected-diff">中级</span>
                            </div>
                        </div>
                        <div class="hub-stage-cta">
                            <button id="start-game-btn" class="stage-orb-btn" aria-label="选择关卡">进入关卡</button>
                        </div>
                    </div>
                </div>

                <div class="hub-row hub-row-icons" aria-label="功能入口">
                    <button id="shop-btn" class="hub-icon-btn" title="技能">
                        <span class="hub-icon-emoji">✨</span>
                        <span class="hub-icon-text">技能</span>
                    </button>
                    <button id="hub-store-btn" class="hub-icon-btn" disabled title="商店（敬请期待）">
                        <span class="hub-icon-emoji">🏪</span>
                        <span class="hub-icon-text">商店</span>
                    </button>
                    <button id="hub-mail-btn" class="hub-icon-btn" title="活动">
                        <span class="hub-icon-emoji">📮</span>
                        <span class="hub-icon-text">活动</span>
                    </button>
                    <button id="hub-settings-btn" class="hub-icon-btn" title="设置">
                        <span class="hub-icon-emoji">⚙</span>
                        <span class="hub-icon-text">设置</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Secondary Panel (Profile / Activities etc.) -->
    <div id="secondary-panel" class="panel hidden" aria-hidden="true">
        <div id="panel-backdrop" class="panel-backdrop"></div>
        <div class="panel-sheet" role="dialog" aria-modal="true" aria-label="二级面板">
            <div class="panel-header">
                <button id="panel-back-btn" class="panel-back" title="返回/关闭">←</button>
                <div class="panel-crumbs" id="panel-crumbs">大厅</div>
                <div class="panel-header-right">
                    <div class="panel-shards-pill" title="技能碎片（用于局外技能升级）">
                        <span class="panel-shards-icon">💠</span>
                        <span class="panel-shards-val" id="panel-shards-val">0</span>
                    </div>
                    <div class="panel-shards-pill" title="金币">
                        <span class="panel-shards-icon">🪙</span>
                        <span class="panel-shards-val" id="panel-gold-val">0</span>
                    </div>
                    <div class="panel-shards-pill" title="宝石">
                        <span class="panel-shards-icon">💎</span>
                        <span class="panel-shards-val" id="panel-gems-val">0</span>
                    </div>
                    <button id="panel-close-btn" class="panel-close" title="关闭">✕</button>
                </div>
            </div>
            <div id="panel-views" class="panel-views" aria-label="面板视图栈">
                <!-- Profile -->
                <section class="panel-view" data-view="profile">
                    <div class="panel-section-title">个人信息</div>
                    <div class="panel-grid">
                        <button class="panel-item" data-nav="status" title="查看当前玩家信息">
                            <div class="panel-item-icon">📊</div>
                            <div class="panel-item-name">状态</div>
                        </button>
                        <button class="panel-item" data-nav="bag">
                            <div class="panel-item-icon">🎒</div>
                            <div class="panel-item-name">背包</div>
                        </button>
                        <button class="panel-item" data-nav="equip">
                            <div class="panel-item-icon">🛡</div>
                            <div class="panel-item-name">装备</div>
                        </button>
                        <button class="panel-item" disabled title="即将加入：成就/图鉴">
                            <div class="panel-item-icon">🏆</div>
                            <div class="panel-item-name">成就</div>
                        </button>
                    </div>
                </section>

                <!-- Status (Profile sub-view) -->
                <section class="panel-view" data-view="status">
                    <div class="panel-section-title">状态</div>
                    <div id="panel-status-root" class="panel-list"></div>
                </section>

                <!-- Bag -->
                <section class="panel-view" data-view="bag">
                    <div class="panel-section-title">背包</div>
                    <div class="panel-list">
                        <div class="panel-card">
                            <div class="panel-card-title">背包内容</div>
                            <div class="panel-card-desc">这里未来展示道具/材料/装备等（上下滑动）。</div>
                        </div>
                        <div class="panel-card">
                            <div class="panel-card-title">筛选 / 排序</div>
                            <div class="panel-card-desc">占位：按品质/类型筛选。</div>
                        </div>
                    </div>
                </section>

                <!-- Equip -->
                <section class="panel-view" data-view="equip">
                    <div class="panel-section-title">装备</div>
                    <div class="panel-list">
                        <div class="panel-card">
                            <div class="panel-card-title">角色装备栏</div>
                            <div class="panel-card-desc">这里未来展示装备位/强化/对比等（上下滑动）。</div>
                        </div>
                        <div class="panel-card">
                            <div class="panel-card-title">传承装备</div>
                            <div class="panel-card-desc">占位：显示已激活传承。</div>
                        </div>
                    </div>
                </section>

                <!-- Activities -->
                <section class="panel-view" data-view="activities">
                    <div class="panel-section-title">活动</div>
                    <div class="panel-list">
                        <div class="panel-card">
                            <div class="panel-card-title">新手七日 · 奖励</div>
                            <div class="panel-card-desc">完成任意关卡获得奖励（占位文案）。上下滑动浏览更多。</div>
                        </div>
                        <div class="panel-card">
                            <div class="panel-card-title">节日活动 · 加成</div>
                            <div class="panel-card-desc">通关掉落 +10%（占位文案）。</div>
                        </div>
                        <div class="panel-card">
                            <div class="panel-card-title">挑战任务 · 周常</div>
                            <div class="panel-card-desc">完成目标领取金币/宝石（占位文案）。</div>
                        </div>
                        <div class="panel-card">
                            <div class="panel-card-title">更多活动…</div>
                            <div class="panel-card-desc">这里可以无限加卡片，列表可上下滚动。</div>
                        </div>
                    </div>
                </section>

                <!-- Settings (Hub entry) -->
                <section class="panel-view" data-view="settings">
                    <div class="panel-section-title">设置</div>
                    <div id="panel-settings-root" class="panel-list"></div>
                </section>

                <!-- Stage Select (inside panel system; keep UI) -->
                <section class="panel-view" data-view="stageSelect">
                    <div id="stage-select-screen">
                        <h1>选择关卡</h1>

                        <div class="stage-carousel">
                            <div class="stage-card">
                                <div class="stage-badge" id="stage-unlock-badge">已解锁</div>
                                <div class="stage-title" id="stage-title">第 1 关</div>
                                <div class="stage-desc" id="stage-desc">关卡描述</div>
                                <div class="stage-enemies-title">本关怪物</div>
                                <div id="stage-enemy-preview"></div>

                                <div class="stage-boss-section" id="stage-boss-section">
                                    <div class="stage-boss-title">本关 Boss（固定）</div>
                                    <div id="stage-boss-preview"></div>
                                </div>

                                <div class="stage-loot-section" id="stage-loot-section">
                                    <div class="stage-loot-title">Boss 掉落</div>
                                    <div id="stage-loot-preview"></div>
                                </div>

                                <div class="stage-reward-section" id="stage-reward-section">
                                    <div class="stage-reward-title">通关奖励</div>
                                    <div id="stage-reward-preview"></div>
                                </div>

                                <div class="stage-difficulty-title">难度</div>
                                <div class="difficulty-row" id="difficulty-row">
                                    <button class="diff-btn" data-diff="easy">新手</button>
                                    <button class="diff-btn" data-diff="normal">中级</button>
                                    <button class="diff-btn" data-diff="hard">高级</button>
                                    <button class="diff-btn" data-diff="hell">地狱</button>
                                </div>
                            </div>
                        </div>

                        <div class="menu-buttons" style="margin-top: 18px;">
                            <button id="stage-confirm-btn" class="big-btn">开始</button>
                        </div>
                    </div>
                </section>

                <!-- Skills (Meta growth) -->
                <section class="panel-view" data-view="skills">
                    <div class="panel-section-title">技能</div>
                    <div class="panel-tabs" id="panel-skill-type-tabs" aria-label="技能类型"></div>
                    <div class="panel-tabs" id="panel-skill-arch-tabs" aria-label="技能分系"></div>
                    <div id="panel-skill-list" class="panel-skill-list"></div>
                </section>

                <!-- Skill Detail -->
                <section class="panel-view" data-view="skillDetail">
                    <div id="panel-skill-detail" class="panel-skill-detail"></div>
                </section>
            </div>
        </div>
    </div>

    <!-- Lobby Screen (Between stages) -->
    <div id="lobby-screen" class="hidden">
        <button id="lobby-menu-btn" class="icon-btn screen-close" title="关闭">✕</button>
        <h1>大厅</h1>
        <div class="subtitle">关卡间休整</div>
        <div class="lobby-panel">
            <div class="lobby-row">已完成：第 <span id="lobby-cleared-stage">1</span> 关</div>
            <div class="lobby-row">下一关：第 <span id="lobby-next-stage">2</span> 关</div>
            <div class="lobby-hint">进入下一关将重置等级/经验/技能与本关装备（保留天赋与传家宝）</div>
            <div class="lobby-subtitle">下一关怪物</div>
            <div id="lobby-enemy-list"></div>
        </div>
        <div class="menu-buttons">
            <button id="lobby-next-btn" class="big-btn">进入下一关</button>
        </div>
    </div>

    <!-- Shop Screen (Hidden by default) -->
    <div id="shop-screen" class="hidden">
        <button id="shop-back-btn" class="icon-btn screen-close" title="关闭">✕</button>
        <h2>传承与局外成长</h2>
        <div class="currency-display" title="资源">
            <span class="currency-icon" title="金币">🪙</span> <span id="shop-gold">0</span>
            <span style="opacity:0.45; padding:0 6px;">|</span>
            <span class="currency-icon" title="宝石">💎</span> <span id="shop-gems">0</span>
        </div>
        <div class="currency-display" title="技能碎片（用于局外技能升级）"><span class="currency-icon">💠</span> <span id="shop-skill-shards">0</span></div>
        
        <div id="heirloom-display" class="hidden">
            <h3>传承装备 (已激活)</h3>
            <div id="heirloom-list"></div>
        </div>

        <div id="skill-upgrade-section">
            <h3>技能升级（局外成长）</h3>
            <div class="skill-unlock-hint">所有技能统一局外等级 0~20。Lv.1 的效果就是“解锁该技能”，解锁后才会进入局内升级池；Lv.2~20 会逐步强化伤害/范围/CD/数量/机制。</div>
            <div id="skill-upgrade-controls" class="skill-upgrade-controls">
                <div id="skill-upgrade-tabs" class="skill-upgrade-tabs"></div>
                <div class="skill-upgrade-tools">
                    <input id="skill-upgrade-search" class="skill-upgrade-search" type="text" placeholder="搜索技能名 / 关键词…" />
                    <label class="skill-upgrade-toggle">
                        <input id="skill-upgrade-show-locked" type="checkbox" checked />
                        显示未解锁
                    </label>
                    <button id="skill-upgrade-expand-all" class="small-btn">全部展开</button>
                    <button id="skill-upgrade-collapse-all" class="small-btn">全部折叠</button>
            </div>
            </div>
            <div class="skill-upgrade-actions">
                <button id="skill-upgrade-reset-btn" class="small-btn danger">重置局外升级（返还金币/宝石）</button>
            </div>
            <div id="skill-upgrade-list"></div>
        </div>
        
    </div>

    <!-- Start Bonus Modal -->
    <div id="start-bonus-modal" class="modal hidden">
        <div class="modal-content">
            <h2>轮回馈赠</h2>
            <p>获得初始技能：</p>
            <h3 id="bonus-skill-name" style="color: #ffd700;"></h3>
            <p id="bonus-skill-desc"></p>
            <button id="start-bonus-confirm-btn">开始战斗</button>
        </div>
    </div>

    <div id="game-container" class="hidden">
        <canvas id="gameCanvas"></canvas>

        <!-- Mobile Controls: Virtual Joystick (Hidden by default) -->
        <div id="mobile-controls" class="hidden" aria-hidden="true">
            <div id="joystick-zone" aria-hidden="true"></div>
            <div id="joystick" aria-hidden="true">
                <div id="joystick-knob" aria-hidden="true"></div>
            </div>
        </div>
        
        <!-- HUD -->
        <div id="hud">
            <div id="top-bar">
                <div id="stats-summary">
                    <!-- Keep hp-display for JS, but hide it (we use bar + text). -->
                    <span id="hp-display" class="hud-sr">100/100</span>
                    <div class="hud-vitals" aria-label="生命与经验">
                        <div id="hp-bar-container" aria-label="生命条">
                            <div id="hp-badge">❤</div>
                            <div id="hp-bar"></div>
                            <div id="hp-text">HP</div>
                        </div>
                        <div id="exp-bar-container" aria-label="经验条">
                            <div id="exp-bar"></div>
                            <div id="exp-text">EXP</div>
                            <div id="level-badge">1</div>
                        </div>
                    </div>
                    <div class="stat-box">Stage: <span id="stage-display">1</span> - <span id="wave-display">1</span>/<span id="wave-total">10</span></div>
                </div>
                <div id="controls-top">
                    <button id="pause-btn" class="icon-btn">⏸</button>
                </div>
            </div>

            <!-- Combo & Message Display -->
            <div id="game-messages">
                <div id="combo-container" class="hidden">
                    <span id="combo-count">0</span> <span class="combo-label">COMBO</span>
                </div>
                <div id="frenzy-msg" class="hidden">FRENZY!</div>
            </div>

            <!-- Active Skill Icons -->
            <div id="active-skills"></div>

            <!-- Boss HP Bar -->
            <div id="boss-hp-container" class="hidden">
                <div id="boss-name">BOSS</div>
                <div id="boss-hp-bar-bg">
                    <div id="boss-hp-bar"></div>
                </div>
            </div>

            <!-- Bottom bar removed: HP/EXP moved to top-left for cleaner HUD -->
        </div>

        <!-- Pause / Personal Info Modal -->
        <div id="pause-modal" class="modal hidden">
            <div class="modal-content">
                <h2>暂停 · 个人信息</h2>
                <div id="full-stats-panel">
                    <!-- Stats injected here -->
                </div>
                <button id="resume-btn">继续游戏</button>
                <button id="quit-btn" style="background-color: #d32f2f;">放弃轮回</button>
            </div>
        </div>

        <!-- Upgrade/Chest Modal -->
        <div id="upgrade-modal" class="modal hidden">
            <div class="modal-content">
                <h2 id="modal-title">升级了！</h2>
                <div id="upgrade-options"></div>
            </div>
        </div>

        <!-- Loot Modal -->
        <div id="loot-modal" class="modal hidden">
            <div class="modal-content loot-content">
                <h2 class="loot-title">BOSS 击杀!</h2>
                <div id="loot-display"></div>
                <button id="loot-confirm-btn">收入囊中</button>
            </div>
        </div>

        <!-- Stage Clear Modal -->
        <div id="stage-clear-modal" class="modal hidden">
            <div class="modal-content">
                <h2>关卡完成</h2>
                <p>休整一下，准备下一关</p>
                <div id="intermission-talents"></div>
                <button id="next-stage-btn" class="big-btn">进入下一关</button>
            </div>
        </div>


        <!-- Inventory Full Modal -->
        <div id="inventory-modal" class="modal hidden">
            <div class="modal-content">
                <h2>装备已满！</h2>
                <p>获得新装备：<span id="new-item-name" class="highlight-text"></span></p>
                <p>选择替换或丢弃。</p>
                <div id="inventory-grid"></div>
                <button id="discard-btn" style="background-color: #d32f2f;">丢弃新装备</button>
            </div>
        </div>

        <!-- Game Over -->
        <div id="game-over-modal" class="modal hidden">
            <div class="modal-content">
                <h2 id="end-title">游戏结束</h2>
                <p>存活时间: <span id="final-time"></span></p>
                <p title="获得技能碎片（用于局外技能升级）"><span class="currency-icon">💠</span> +<span id="gained-points">0</span></p>
                <p title="本轮获得金币/宝石">
                    <span class="currency-icon" title="金币">🪙</span> +<span id="gained-gold">0</span>
                    <span style="opacity:0.45; padding:0 6px;">|</span>
                    <span class="currency-icon" title="宝石">💎</span> +<span id="gained-gems">0</span>
                </p>
                <button id="return-menu-btn">返回主菜单</button>
            </div>
        </div>
    </div>

<!-- UI Icon Sprite (skill icons, etc.) -->
<svg aria-hidden="true" class="ui-sprite" width="0" height="0" style="position:absolute; width:0; height:0; overflow:hidden;">
    <symbol id="sigil-dart" viewBox="0 0 24 24">
        <path d="M4 20L20 4" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round"/>
        <path d="M14 4h6v6" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <symbol id="sigil-bolt" viewBox="0 0 24 24">
        <path d="M13 2L4 14h7l-1 8 10-14h-7l0-6z" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linejoin="round"/>
    </symbol>
    <symbol id="sigil-blade" viewBox="0 0 24 24">
        <path d="M12 3l3 6-3 3-3-3 3-6z" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linejoin="round"/>
        <path d="M12 12v9" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
    </symbol>
    <symbol id="sigil-meteor" viewBox="0 0 24 24">
        <path d="M4 10c6 0 8-6 16-6" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
        <path d="M14 14a4 4 0 1 1-8 0a4 4 0 0 1 8 0z" fill="none" stroke="currentColor" stroke-width="2.2"/>
    </symbol>
    <symbol id="sigil-shield" viewBox="0 0 24 24">
        <path d="M12 2l8 4v6c0 6-4 9-8 10C8 21 4 18 4 12V6l8-4z" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linejoin="round"/>
    </symbol>
    <symbol id="sigil-toxin" viewBox="0 0 24 24">
        <path d="M8 3h8" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
        <path d="M10 3v5l-4 7a6 6 0 0 0 12 0l-4-7V3" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linejoin="round"/>
        <path d="M9 14h6" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
    </symbol>
    <symbol id="sigil-mushroom" viewBox="0 0 24 24">
        <path d="M6 11a6 6 0 0 1 12 0H6z" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linejoin="round"/>
        <path d="M10 11v8a2 2 0 0 0 4 0v-8" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
    </symbol>
    <symbol id="sigil-frost" viewBox="0 0 24 24">
        <path d="M12 2v20M4 7l16 10M20 7L4 17" fill="none" stroke="currentColor" stroke-width="2.0" stroke-linecap="round"/>
    </symbol>
    <symbol id="sigil-sword" viewBox="0 0 24 24">
        <path d="M14 3l7 7-2 2-7-7 2-2z" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linejoin="round"/>
        <path d="M12 5L4 13v3h3l8-8" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linejoin="round"/>
    </symbol>
    <symbol id="sigil-swiftness" viewBox="0 0 24 24">
        <path d="M4 14c2-4 6-6 10-6 4 0 6 2 6 2" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
        <path d="M6 18h10" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
    </symbol>
    <symbol id="sigil-heart" viewBox="0 0 24 24">
        <path d="M12 21s-7-4.6-9-9c-1.2-2.8.4-6 3.6-7 2-.6 4 .2 5.4 1.7C13.4 5.2 15.4 4.4 17.4 5c3.2 1 4.8 4.2 3.6 7-2 4.4-9 9-9 9z" fill="none" stroke="currentColor" stroke-width="2.0" stroke-linejoin="round"/>
    </symbol>
    <symbol id="sigil-arcane" viewBox="0 0 24 24">
        <path d="M12 3l8 5v8l-8 5-8-5V8l8-5z" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linejoin="round"/>
        <path d="M12 7v10" fill="none" stroke="currentColor" stroke-width="2.0" stroke-linecap="round"/>
    </symbol>
</svg>
    <script src="game.js"></script>
</body>
</html>