<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>提莫快跑 - 轮回 (Heirloom Edition)</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Damage Overlay -->
    <div id="damage-overlay"></div>

    <!-- Force Landscape Overlay (mobile) -->
    <div id="rotate-overlay" class="hidden" aria-hidden="true">
        <div class="rotate-card" role="dialog" aria-modal="true" aria-label="横屏提示">
            <div class="rotate-icon">📱↻</div>
            <div class="rotate-title">请横屏游玩</div>
            <div class="rotate-desc">本游戏为横屏手游体验。将手机旋转为横屏后自动继续。</div>
            <button id="rotate-try-btn" class="rotate-btn">点击尝试锁定横屏</button>
            <button id="rotate-continue-btn" class="rotate-btn secondary">我已横屏，继续</button>
            <div class="rotate-hint">若浏览器不支持强制锁定，请手动旋转屏幕。</div>
        </div>
    </div>

    <!-- Splash / Loading Screen -->
    <div id="splash-screen">
        <div class="splash-inner">
            <div class="splash-title">提莫快跑</div>
            <div class="splash-subtitle">轮回 · 传承</div>
            <div class="splash-tip">点击进入</div>
        </div>
    </div>

    <!-- Main Menu -->
    <div id="main-menu" class="hidden">
        <div class="hub-wrap stage-focus">
            <div class="hub-shell">
                <!-- Left sidebar -->
                <div class="hub-side left" aria-label="左侧功能栏">
                    <button id="hub-profile-btn" class="hub-avatar-btn" title="个人信息">
                        <div class="hub-avatar-ring">
                            <div class="hub-avatar">👤</div>
                        </div>
                        <div class="hub-avatar-name">玩家</div>
                    </button>
                    <div class="hub-side-stack">
                        <button id="shop-btn" class="hub-icon-btn" title="技能成长（局外升级/传承）">
                            <span class="hub-icon-emoji">✨</span>
                            <span class="hub-icon-text">技能</span>
                        </button>
                    </div>
                </div>

                <!-- Center -->
                <div class="hub-center">
                    <div class="hub-topbar">
                        <div class="hub-top-stats">
                            <div class="hub-pill" title="技能碎片">
                                <span class="hub-pill-icon">💠</span>
                                <span class="hub-pill-label">碎片</span>
                                <span class="hub-pill-value" id="meta-skill-shards">0</span>
                            </div>
                            <div class="hub-pill" title="已解锁关卡">
                                <span class="hub-pill-icon">🔓</span>
                                <span class="hub-pill-label">解锁</span>
                                <span class="hub-pill-value">第 <span id="hub-unlocked-stage">1</span> 关</span>
                            </div>
                        </div>
                    </div>

                    <div class="hub-stage-card">
                        <div class="hub-stage-header">
                            <div class="hub-stage-kicker">主线 · 进入关卡</div>
                            <div class="hub-stage-meta">
                                <div class="hub-stage-line">上次：第 <span id="hub-last-stage">1</span> 关 · <span id="hub-last-diff">中级</span></div>
                                <div class="hub-stage-line dim">建议：先打关卡获取碎片，用于局外技能成长</div>
                            </div>
                        </div>

                        <div class="hub-stage-cta">
                            <button id="start-game-btn" class="stage-orb-btn" aria-label="选择关卡">进入关卡</button>
                            <div class="stage-orb-hint">选关界面将自动定位到上次选择，可随时调整难度 / Boss / 掉落预览</div>
                        </div>
                    </div>
                </div>

                <!-- Right sidebar -->
                <div class="hub-side right" aria-label="右侧功能栏">
                    <div class="hub-side-stack">
                        <button id="hub-store-btn" class="hub-icon-btn" disabled title="即将加入：商店系统">
                            <span class="hub-icon-emoji">🏪</span>
                            <span class="hub-icon-text">商店</span>
                        </button>

                        <button id="hub-mail-btn" class="hub-icon-btn" title="活动">
                            <span class="hub-icon-emoji">📮</span>
                            <span class="hub-icon-text">活动</span>
                        </button>

                        <button id="hub-settings-btn" class="hub-icon-btn" title="设置">
                            <span class="hub-icon-emoji">⚙</span>
                            <span class="hub-icon-text">设置</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="hub-footer">
                <div class="hub-footnote">目标：让你“进来就开打”。其它系统入口做成小 icon，后续直接替换为真实功能即可。</div>
            </div>
        </div>
    </div>

    <!-- Secondary Panel (Profile / Activities etc.) -->
    <div id="secondary-panel" class="panel hidden" aria-hidden="true">
        <div id="panel-backdrop" class="panel-backdrop"></div>
        <div class="panel-sheet" role="dialog" aria-modal="true" aria-label="二级面板">
            <div class="panel-header">
                <button id="panel-back-btn" class="panel-back" title="返回/关闭">←</button>
                <div class="panel-crumbs" id="panel-crumbs">大厅</div>
                <button id="panel-close-btn" class="panel-close" title="关闭">✕</button>
            </div>
            <div id="panel-views" class="panel-views" aria-label="面板视图栈">
                <!-- Profile -->
                <section class="panel-view" data-view="profile">
                    <div class="panel-section-title">个人信息</div>
                    <div class="panel-grid">
                        <button class="panel-item" data-nav="status" title="查看当前玩家信息">
                            <div class="panel-item-icon">📊</div>
                            <div class="panel-item-name">状态</div>
                        </button>
                        <button class="panel-item" data-nav="bag">
                            <div class="panel-item-icon">🎒</div>
                            <div class="panel-item-name">背包</div>
                        </button>
                        <button class="panel-item" data-nav="equip">
                            <div class="panel-item-icon">🛡</div>
                            <div class="panel-item-name">装备</div>
                        </button>
                        <button class="panel-item" disabled title="即将加入：成就/图鉴">
                            <div class="panel-item-icon">🏆</div>
                            <div class="panel-item-name">成就</div>
                        </button>
                    </div>
                </section>

                <!-- Status (Profile sub-view) -->
                <section class="panel-view" data-view="status">
                    <div class="panel-section-title">状态</div>
                    <div id="panel-status-root" class="panel-list"></div>
                </section>

                <!-- Bag -->
                <section class="panel-view" data-view="bag">
                    <div class="panel-section-title">背包</div>
                    <div class="panel-list">
                        <div class="panel-card">
                            <div class="panel-card-title">背包内容</div>
                            <div class="panel-card-desc">这里未来展示道具/材料/装备等（上下滑动）。</div>
                        </div>
                        <div class="panel-card">
                            <div class="panel-card-title">筛选 / 排序</div>
                            <div class="panel-card-desc">占位：按品质/类型筛选。</div>
                        </div>
                    </div>
                </section>

                <!-- Equip -->
                <section class="panel-view" data-view="equip">
                    <div class="panel-section-title">装备</div>
                    <div class="panel-list">
                        <div class="panel-card">
                            <div class="panel-card-title">角色装备栏</div>
                            <div class="panel-card-desc">这里未来展示装备位/强化/对比等（上下滑动）。</div>
                        </div>
                        <div class="panel-card">
                            <div class="panel-card-title">传承装备</div>
                            <div class="panel-card-desc">占位：显示已激活传承。</div>
                        </div>
                    </div>
                </section>

                <!-- Activities -->
                <section class="panel-view" data-view="activities">
                    <div class="panel-section-title">活动</div>
                    <div class="panel-list">
                        <div class="panel-card">
                            <div class="panel-card-title">新手七日 · 奖励</div>
                            <div class="panel-card-desc">完成任意关卡获得奖励（占位文案）。上下滑动浏览更多。</div>
                        </div>
                        <div class="panel-card">
                            <div class="panel-card-title">节日活动 · 加成</div>
                            <div class="panel-card-desc">通关掉落 +10%（占位文案）。</div>
                        </div>
                        <div class="panel-card">
                            <div class="panel-card-title">挑战任务 · 周常</div>
                            <div class="panel-card-desc">完成目标领取碎片（占位文案）。</div>
                        </div>
                        <div class="panel-card">
                            <div class="panel-card-title">更多活动…</div>
                            <div class="panel-card-desc">这里可以无限加卡片，列表可上下滚动。</div>
                        </div>
                    </div>
                </section>

                <!-- Settings (Hub entry) -->
                <section class="panel-view" data-view="settings">
                    <div class="panel-section-title">设置</div>
                    <div id="panel-settings-root" class="panel-list"></div>
                </section>

                <!-- Stage Select (inside panel system; keep UI) -->
                <section class="panel-view" data-view="stageSelect">
                    <div id="stage-select-screen">
                        <h1>选择关卡</h1>
                        <div class="subtitle">左右切换 · 选择难度</div>
                        <div class="currency-display">技能碎片: <span id="stage-select-skill-shards">0</span></div>

                        <div class="stage-carousel">
                            <button id="stage-prev" class="icon-btn stage-nav" title="上一关">◀</button>
                            <div class="stage-card">
                                <div class="stage-badge" id="stage-unlock-badge">已解锁</div>
                                <div class="stage-title" id="stage-title">第 1 关</div>
                                <div class="stage-desc" id="stage-desc">关卡描述</div>
                                <div class="stage-enemies-title">本关怪物</div>
                                <div id="stage-enemy-preview"></div>

                                <div class="stage-boss-title">本关 Boss（固定）</div>
                                <div id="stage-boss-preview"></div>

                                <div class="stage-loot-title">Boss 掉落</div>
                                <div id="stage-loot-preview"></div>

                                <div class="stage-difficulty-title">难度</div>
                                <div class="difficulty-row" id="difficulty-row">
                                    <button class="diff-btn" data-diff="easy">新手</button>
                                    <button class="diff-btn" data-diff="normal">中级</button>
                                    <button class="diff-btn" data-diff="hard">高级</button>
                                    <button class="diff-btn" data-diff="hell">地狱</button>
                                </div>
                            </div>
                            <button id="stage-next" class="icon-btn stage-nav" title="下一关">▶</button>
                        </div>

                        <div class="menu-buttons" style="margin-top: 18px;">
                            <button id="stage-confirm-btn" class="big-btn">开始</button>
                        </div>
                    </div>
                </section>

                <!-- Skills (Meta growth) -->
                <section class="panel-view" data-view="skills">
                    <div class="panel-section-title">技能成长</div>
                    <div class="panel-tabs" id="panel-skill-type-tabs" aria-label="技能类型"></div>
                    <div class="panel-tabs" id="panel-skill-arch-tabs" aria-label="技能分系"></div>
                    <div class="panel-subbar">
                        <div class="panel-pill">
                            <span class="panel-pill-icon">💠</span>
                            <span class="panel-pill-label">碎片</span>
                            <span class="panel-pill-value" id="panel-skill-shards">0</span>
                        </div>
                    </div>
                    <div id="panel-skill-list" class="panel-skill-list"></div>
                </section>

                <!-- Skill Detail -->
                <section class="panel-view" data-view="skillDetail">
                    <div id="panel-skill-detail" class="panel-skill-detail"></div>
                </section>
            </div>
        </div>
    </div>

    <!-- Lobby Screen (Between stages) -->
    <div id="lobby-screen" class="hidden">
        <button id="lobby-menu-btn" class="icon-btn screen-close" title="关闭">✕</button>
        <h1>大厅</h1>
        <div class="subtitle">关卡间休整</div>
        <div class="lobby-panel">
            <div class="lobby-row">已完成：第 <span id="lobby-cleared-stage">1</span> 关</div>
            <div class="lobby-row">下一关：第 <span id="lobby-next-stage">2</span> 关</div>
            <div class="lobby-hint">进入下一关将重置等级/经验/技能与本关装备（保留天赋与传家宝）</div>
            <div class="lobby-subtitle">下一关怪物</div>
            <div id="lobby-enemy-list"></div>
        </div>
        <div class="menu-buttons">
            <button id="lobby-next-btn" class="big-btn">进入下一关</button>
        </div>
    </div>

    <!-- Shop Screen (Hidden by default) -->
    <div id="shop-screen" class="hidden">
        <button id="shop-back-btn" class="icon-btn screen-close" title="关闭">✕</button>
        <h2>传承与局外成长</h2>
        <div class="currency-display">技能碎片: <span id="shop-skill-shards">0</span></div>
        
        <div id="heirloom-display" class="hidden">
            <h3>传承装备 (已激活)</h3>
            <div id="heirloom-list"></div>
        </div>

        <div id="skill-upgrade-section">
            <h3>技能升级（局外成长）</h3>
            <div class="skill-unlock-hint">所有技能统一局外等级 0~20。Lv.1 的效果就是“解锁该技能”，解锁后才会进入局内升级池；Lv.2~20 会逐步强化伤害/范围/CD/数量/机制。</div>
            <div id="skill-upgrade-controls" class="skill-upgrade-controls">
                <div id="skill-upgrade-tabs" class="skill-upgrade-tabs"></div>
                <div class="skill-upgrade-tools">
                    <input id="skill-upgrade-search" class="skill-upgrade-search" type="text" placeholder="搜索技能名 / 关键词…" />
                    <label class="skill-upgrade-toggle">
                        <input id="skill-upgrade-show-locked" type="checkbox" checked />
                        显示未解锁
                    </label>
                    <button id="skill-upgrade-expand-all" class="small-btn">全部展开</button>
                    <button id="skill-upgrade-collapse-all" class="small-btn">全部折叠</button>
                </div>
            </div>
            <div class="skill-upgrade-actions">
                <button id="skill-upgrade-reset-btn" class="small-btn danger">重置局外升级（返还碎片）</button>
            </div>
            <div id="skill-upgrade-list"></div>
        </div>

    </div>

    <!-- Start Bonus Modal -->
    <div id="start-bonus-modal" class="modal hidden">
        <div class="modal-content">
            <h2>轮回馈赠</h2>
            <p>获得初始技能：</p>
            <h3 id="bonus-skill-name" style="color: #ffd700;"></h3>
            <p id="bonus-skill-desc"></p>
            <button id="start-bonus-confirm-btn">开始战斗</button>
        </div>
    </div>

    <div id="game-container" class="hidden">
        <canvas id="gameCanvas"></canvas>

        <!-- Mobile Controls: Virtual Joystick (Hidden by default) -->
        <div id="mobile-controls" class="hidden" aria-hidden="true">
            <div id="joystick-zone" aria-hidden="true"></div>
            <div id="joystick" aria-hidden="true">
                <div id="joystick-knob" aria-hidden="true"></div>
            </div>
        </div>
        
        <!-- HUD -->
        <div id="hud">
            <div id="top-bar">
                <div id="stats-summary">
                    <div class="stat-box">HP: <span id="hp-display">100/100</span></div>
                    <div class="stat-box">Stage: <span id="stage-display">1</span> - <span id="wave-display">1</span>/<span id="wave-total">10</span></div>
                </div>
                <div id="controls-top">
                    <button id="pause-btn" class="icon-btn">⏸</button>
                    <button id="sound-btn" class="icon-btn" title="音效">🔊</button>
                </div>
            </div>

            <!-- Combo & Message Display -->
            <div id="game-messages">
                <div id="combo-container" class="hidden">
                    <span id="combo-count">0</span> <span class="combo-label">COMBO</span>
                </div>
                <div id="frenzy-msg" class="hidden">FRENZY!</div>
            </div>

            <!-- Active Skill Icons -->
            <div id="active-skills"></div>

            <!-- Boss HP Bar -->
            <div id="boss-hp-container" class="hidden">
                <div id="boss-name">BOSS</div>
                <div id="boss-hp-bar-bg">
                    <div id="boss-hp-bar"></div>
                </div>
            </div>

            <!-- Bottom Area: Equipment & EXP -->
            <div id="bottom-bar">
                <div id="equipment-container"></div>
                <div id="exp-bar-container">
                    <div id="exp-bar"></div>
                    <div id="exp-text">EXP</div>
                    <div id="level-badge">1</div>
                </div>
            </div>
        </div>

        <!-- Pause / Personal Info Modal -->
        <div id="pause-modal" class="modal hidden">
            <div class="modal-content">
                <h2>暂停 · 个人信息</h2>
                <div id="full-stats-panel">
                    <!-- Stats injected here -->
                </div>
                <button id="resume-btn">继续游戏</button>
                <button id="quit-btn" style="background-color: #d32f2f;">放弃轮回</button>
            </div>
        </div>

        <!-- Upgrade/Chest Modal -->
        <div id="upgrade-modal" class="modal hidden">
            <div class="modal-content">
                <h2 id="modal-title">升级了！</h2>
                <div id="upgrade-options"></div>
            </div>
        </div>

        <!-- Loot Modal -->
        <div id="loot-modal" class="modal hidden">
            <div class="modal-content loot-content">
                <h2 class="loot-title">BOSS 击杀!</h2>
                <div id="loot-display"></div>
                <button id="loot-confirm-btn">收入囊中</button>
            </div>
        </div>

        <!-- Stage Clear Modal -->
        <div id="stage-clear-modal" class="modal hidden">
            <div class="modal-content">
                <h2>关卡完成</h2>
                <p>休整一下，准备下一关</p>
                <div id="intermission-talents"></div>
                <button id="next-stage-btn" class="big-btn">进入下一关</button>
            </div>
        </div>


        <!-- Inventory Full Modal -->
        <div id="inventory-modal" class="modal hidden">
            <div class="modal-content">
                <h2>装备已满！</h2>
                <p>获得新装备：<span id="new-item-name" class="highlight-text"></span></p>
                <p>选择替换或丢弃。</p>
                <div id="inventory-grid"></div>
                <button id="discard-btn" style="background-color: #d32f2f;">丢弃新装备</button>
            </div>
        </div>

        <!-- Game Over -->
        <div id="game-over-modal" class="modal hidden">
            <div class="modal-content">
                <h2 id="end-title">游戏结束</h2>
                <p>存活时间: <span id="final-time"></span></p>
                <p>获得技能碎片: <span id="gained-points">0</span></p>
                <button id="return-menu-btn">返回主菜单</button>
            </div>
        </div>
    </div>
    <script src="game.js"></script>
</body>
</html>